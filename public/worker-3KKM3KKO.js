var e={canvas:{shortSide:1080,longSide:1620},frame:{border:75},logo:{image:{side:118},circle:{margin:22,padding:4,color:"white",strokeWidth:8}},colors:{distretto:"#d41367",doc:"#0d4e8c",etruria:"#17b2dc",galileo:"#f5a14d",magnifico:"#138a62",montalbano:"#e71d75",tirreno:"#ee7046"},hashes:{frames:{landscape:"28846",portrait:"18461",square:"24840"},logos:{distretto:"06365",doc:"36231",etruria:"08921",galileo:"45306",magnifico:"13043",montalbano:"16037",tirreno:"63195"}}};async function d(o){let n=await fetch(`/logos/${o}-${e.hashes.logos[o]}.png`);return createImageBitmap(await n.blob())}var u=I(),h=P();async function p(o,n,t,r,c,l,a){let m=new OffscreenCanvas(o,n),i=m.getContext("2d");if(i===null)throw new Error("Canvas 2D rendering context is not supported");y(t,i,o,n),S(r,a,i);let g=0;return w(c,a??e.colors.distretto,g++,i,o,n),l!==null&&a!==null&&w(l,a,g++,i,o,n),new URL(URL.createObjectURL(await m.convertToBlob()))}function y(o,n,t,r){n.drawImage(o,e.frame.border,e.frame.border,t-e.frame.border*2,r-e.frame.border*2)}function S(o,n,t){for(let r of o.paths)n!==null&&r.customizable?t.fillStyle=n:t.fillStyle=r.fill,t.fill(new Path2D(r.definition))}function w(o,n,t,r,c,l){let[a,m]=v(t),[i,g]=C(a,m,c,l);L(i,g,n,r);let[f,s]=k(a,m,c,l);r.drawImage(o,f,s,e.logo.image.side,e.logo.image.side)}function v(o){let n=-Math.PI/4-Math.PI/2*o;return[Math.cos,Math.sin].map(t=>Math.sign(t(n)))}function L(o,n,t,r){r.beginPath(),r.ellipse(o,n,u,u,0,0,Math.PI*2),r.closePath(),r.fillStyle=e.logo.circle.color,r.fill(),r.strokeStyle=t,r.lineWidth=e.logo.circle.strokeWidth,r.stroke()}function C(o,n,t,r){return[t/2+o*(t/2-e.logo.circle.margin-Math.floor(e.logo.circle.strokeWidth/2)-u),r/2-n*(r/2-e.logo.circle.margin-Math.floor(e.logo.circle.strokeWidth/2)-u)]}function k(o,n,t,r){return[t/2+o*(t/2-h-(o>0?e.logo.image.side:0)),r/2-n*(r/2-h-(n<0?e.logo.image.side:0))]}function I(){return Math.ceil(Math.ceil(e.logo.image.side/2*Math.sqrt(2))/2)*2+e.logo.circle.padding+Math.floor(e.logo.circle.strokeWidth/2)}function P(){return e.logo.circle.margin+Math.floor(e.logo.circle.strokeWidth/2)+u-e.logo.image.side/2}addEventListener("message",async o=>{let{format:n,frame:t,logo:r,images:c}=o.data,[l,a]={landscape:[e.canvas.longSide,e.canvas.shortSide],portrait:[e.canvas.shortSide,e.canvas.longSide],square:[e.canvas.shortSide,e.canvas.shortSide]}[n],m=await d("distretto"),i=r!==null?await d(r):null,g=r!==null?e.colors[r]:null,f=await Promise.all(c.map(async s=>{let M=await createImageBitmap(await(await fetch(s.url)).blob(),s.x,s.y,s.width,s.height);return{filename:s.filename.split(".").slice(0,-1).join("")+"_con_cornice.png",url:(await p(l,a,M,t,m,i,g)).href}}));postMessage(f)});
